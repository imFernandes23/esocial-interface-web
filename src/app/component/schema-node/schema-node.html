<div class="box" [style.marginLeft.px]="depth * 12">
  <div class="box-head" (click)="onHeaderClick($event)">
    <div class="left">
      <span class="tag">{{ node.name }}</span>
      <span class="doc" *ngIf="typeName">type: {{ typeName }}</span>
      <span class="doc" *ngIf="base" style="margin-left:8px">base: {{ base }}</span>
      <span class="doc" *ngIf="use" style="margin-left:8px">use: {{ use }}</span>
    </div>
    <div class="right">{{ open ? '▾' : '▸' }}</div>
  </div>

  <div class="box-body" *ngIf="open" (click)="$event.stopPropagation()">
    <!-- Documentação do nó-->
    <ng-container *ngIf="(node.meta?.docs || node.source?.meta?.docs) as docs">
      <div class="docbox">
        <div class="docline" *ngFor="let d of docs; trackBy: trackStr">{{ d }}</div>
      </div>
    </ng-container>

    <!-- Ocorrencias-->

    <div class="occurs" *ngIf="showOccursEditor">
      <div class="occ-row">
        <div class="occ-item" *ngIf="occurs?.min === 0 || occMin === 0">
          <label>Mínimo</label>
          <input type="number" min="0" [max]="occMax === 'unbounded' ? null : occMax"
                [value]="occMin" (input)="setOccMin(($event.target ).valueAsNumber)" />
        </div>

        <div class="occ-item">
          <label>Máximo</label>
          <ng-container *ngIf="occMax !== 'unbounded'; else unbounded">
            <input type="number" min="1" [value]="occMax"
                  (input)="setOccMax(($event.target).valueAsNumber)" />
          </ng-container>
          <ng-template #unbounded>
            <input type="number" [value]="50" (input)="setOccMax(($event.target ).valueAsNumber)" />
          </ng-template>
          <label class="chk">
            <input type="checkbox" [checked]="occMax === 'unbounded'" (change)="toggleUnbounded(($event.target).checked)" />
            ilimitado
          </label>
        </div>

        <div class="occ-hint">
          <span>Atual: {{ occurs?.min ?? 1 }}..{{ occurs?.max === 'unbounded' ? '∞' : occurs?.max ?? 1 }}</span>
          <span *ngIf="occMin !== (occurs?.min ?? 1) || occMax !== (occurs?.max ?? 1)">→ Novo: {{ occMin }}..{{ occMax === 'unbounded' ? '∞' : occMax }}</span>
        </div>
      </div>
    </div>

    <!-- FORM de string facets -->
    <div class="sf-box" *ngIf="showStringEditor">
      <div class="sf-row">
        <label class="lbl">Comprimento exato</label>
        <input type="number" min="1" [value]="sfDraft.length ?? ''" placeholder="opcional"
              (input)="setLen(($event.target).valueAsNumber)">
        <span class="hint" *ngIf="stringFacets?.length">mín {{stringFacets?.length}} (não pode diminuir)</span>
      </div>

      <div class="sf-row">
        <label class="lbl">Mínimo</label>
        <input type="number" min="0" [value]="sfDraft.minLength ?? stringFacets?.minLength ?? 0"
              (input)="setMinLen(($event.target).valueAsNumber)">
        <span class="hint" *ngIf="stringFacets?.minLength">mín {{stringFacets?.minLength}} (↑ apenas)</span>
      </div>

    <div class="sf-row">
      <label class="lbl">Máximo</label>
      <input
        type="number" min="1"
        [value]="maxForForm"
        placeholder="{{ inferredMax ? ('sugerido: ' + inferredMax) : 'opcional' }}"
        (input)="setMaxLen(($event.target).valueAsNumber)" />
      <span class="hint"
            *ngIf="stringFacets?.maxLength; else hintInfer">
        máx {{stringFacets?.maxLength}} (↓ apenas)
      </span>
      <ng-template #hintInfer>
        <span class="hint" *ngIf="inferredMax">sugerido pelo nome do tipo</span>
      </ng-template>
    </div>

      <div class="sf-row">
        <label class="lbl">Pattern (regex)</label>
        <input type="text" [value]="(sfDraft.patterns?.[0] ?? stringFacets?.patterns?.[0]) || ''"
              placeholder="ex.: ^\\S.*$" (input)="setPattern(($event.target).value)">
        <span class="hint">adicionar/substituir (mais restritivo)</span>
      </div>
    </div>
    <!-- ↓↓↓ enum como LISTA (sem caixas/toggle) ↓↓↓ -->
    <ng-container *ngIf="node.kind === 'enumeration'; else normalChildren">
      <div class="enum-list">
        <div class="enum-row"
             *ngFor="let val of (node.children || []); trackBy: trackById"
             [class.removed]="isEnumRemoved(val)">
          <div class="enum-left">
            <strong class="enum-value">{{ val.name }}</strong>
            <span class="enum-doc" *ngIf="(val.meta?.docs || val.source?.meta?.docs) as vdocs">
              {{ vdocs[0] || '' }}
            </span>
          </div>
          <div class="enum-actions">
            <button class="btn danger" *ngIf="!isEnumRemoved(val)" (click)="removeEnum(val)">Remover</button>
            <button class="btn" *ngIf="isEnumRemoved(val)" (click)="undoEnum(val)">Desfazer</button>
          </div>
        </div>
      </div>
    </ng-container>

    <!-- render padrão (não-enum) -->
    <ng-template #normalChildren>
      <ng-container *ngIf="filteredChildren().length; else leaf">
        <app-schema-node
          *ngFor="let c of filteredChildren(); trackBy: trackById"
          [node]="c"
          [depth]="depth + 1">
        </app-schema-node>
      </ng-container>
      <ng-template #leaf>
        <p class="muted">— sem filhos —</p>
      </ng-template>
    </ng-template>
  </div>
</div>