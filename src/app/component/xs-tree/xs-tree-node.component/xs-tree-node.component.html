<!-- REPETIDOR: se o nó pode ocorrer mais de uma vez -->
<ng-container *ngIf="isRepeatable(); else notRepeatable">
  <details class="node" open>
    <summary class="sum">
      <span class="name">{{ node.name || node.kind }}</span>

      <!-- NO LITE: controles de repetição -->
      <span class="occ-ctrl" *ngIf="!lite">
        <button type="button" class="btn" (click)="decOcc(node)" [disabled]="!canRemove(node)">−</button>
        <span class="occ">{{ occCount(node) }}</span>
        <button type="button" class="btn" (click)="incOcc(node)" [disabled]="!canAdd(node)">+</button>
      </span>

      <!-- LITE: só um badge com a contagem (se quiser, pode remover essa linha) -->
      <span class="occ-badge" *ngIf="lite">{{ occCount(node) }}</span>
    </summary>

    <div class="children" *ngIf="occCount(node) > 0">
      <ng-container *ngFor="let i of occIndexes(node); let idx = index">
        <div class="instance">
          <div class="inst-header">Instância {{ idx + 1 }}</div>

          <!-- Renderiza a MESMA árvore, mas com repeat desabilitado -->
          <app-xs-tree-node
            [node]="node"
            [vPrefix]="vPrefix"
            [disableRepeat]="true"
            [instanceIndex]="idx"
            [lite]="lite">
          </app-xs-tree-node>
        </div>
      </ng-container>
    </div>
  </details>
</ng-container>

<!-- NÃO REPETÍVEL -->
<ng-template #notRepeatable>
  <ng-container [ngTemplateOutlet]="renderSelf"></ng-container>
</ng-template>

<!-- RENDERIZAÇÃO DO PRÓPRIO NÓ -->
<ng-template #renderSelf>

  <!-- WRAPPER: só desce nos filhos (sem doc, sem inputs) -->
  <ng-container *ngIf="isWrapper(); else normalBox">
    <ng-container *ngFor="let c of node.children">
      <app-xs-tree-node 
        [node]="c" 
        [idPrefix]="idPrefix"
        [vPrefix]="((node.kind || '').toLowerCase() === 'element' ? getVisualPath() : vPrefix)"
        [lite]="lite"
      ></app-xs-tree-node>
    </ng-container>
  </ng-container>

  <ng-template #normalBox>
    <!-- LITE & LEAF: mostra só rótulo: valor -->
    <ng-container *ngIf="lite && isLeafNode(); else fullBox">
      <div class="lite-row">
        <span class="lite-label">{{ label() }}:</span>
        <span class="lite-value">{{ displayValue() || '—' }}</span>
      </div>
    </ng-container>

    <!-- Modo completo OU nó não-leaf no lite -->
    <ng-template #fullBox>
      <details class="node" open>
        <summary class="sum"><span class="name">{{ node.name || node.kind }}</span></summary>

        <!-- DOCBOX: não aparece no lite -->
        <div class="docbox" *ngIf="!lite && node.meta?.docs?.length">
          <ul class="docbox-list">
            <li *ngFor="let d of node.meta?.docs">{{ d }}</li>
          </ul>
        </div>

        <!-- 1) CHOICE -->
        <ng-container *ngIf="isChoice(); else notChoice">
          <!-- NO LITE: sem select -->
          <div class="choice-picker" *ngIf="!lite">
            <label>Escolha uma opção:</label>
            <select [value]="selectedChoiceId()" (change)="onChoose(($any($event.target).value))">
              <option value="" disabled>— selecione —</option>
              <option *ngFor="let opt of node.children" [value]="opt.id">
                {{ opt.name || 'opção' }}
              </option>
            </select>
          </div>

          <!-- Sempre renderiza o ramo escolhido (se houver) -->
          <div class="children" *ngIf="selectedChild() as chosen">
            <app-xs-tree-node 
              [node]="chosen" 
              [idPrefix]="idPrefix"
              [vPrefix]="((node.kind || '').toLowerCase() === 'element' ? getVisualPath() : vPrefix)"
              [lite]="lite">
            </app-xs-tree-node>
          </div>
        </ng-container>

        <!-- 2) NÃO-CHOICE -->
        <ng-template #notChoice>
          <!-- ENUM -->
          <ng-container *ngIf="isEnumList(); else maybeNumber">
            <div class="enum-picker" *ngIf="!lite; else enumLite">
              <label>Selecionar:</label>
              <select [value]="selectedEnum()" (change)="onChooseEnum(($any($event.target).value ))">
                <option value="" disabled>— selecione —</option>
                <option *ngFor="let opt of enumOptions()" [value]="opt.name">
                  {{ enumLabel(opt) }}
                </option>
              </select>
            </div>
            <ng-template #enumLite>
              <div class="lite-row">
                <span class="lite-label">{{ label() }}:</span>
                <span class="lite-value">{{ displayValue() || '—' }}</span>
              </div>
            </ng-template>
          </ng-container>

          <!-- NÚMERO -->
          <ng-template #maybeNumber>
            <div class="number-input" *ngIf="isNumericInput(); else maybeDate">
              <ng-container *ngIf="!lite; else numberLite">
                <input
                  type="number"
                  [value]="numberValue()"
                  (input)="onNumber(($any($event.target).value ))"
                  [attr.min]="minAttr()"
                  [attr.max]="maxAttr()"
                  [attr.step]="stepAttr()"
                  class="text"
                  [class.invalid]="numberError()"
                  [placeholder]="numberHint() || 'número...'"
                  inputmode="decimal"
                />
                <div class="hint" *ngIf="numberHint()">{{ numberHint() }}</div>
                <div class="error" *ngIf="numberError()">{{ numberError() }}</div>
              </ng-container>
              <ng-template #numberLite>
                <div class="lite-row">
                  <span class="lite-label">{{ label() }}:</span>
                  <span class="lite-value">{{ displayValue() || '—' }}</span>
                </div>
              </ng-template>
            </div>
          </ng-template>

          <!-- DATA -->
          <ng-template #maybeDate>
            <div class="date-input" *ngIf="isDateHere(); else maybeString">
              <ng-container *ngIf="!lite; else dateLite">
                <input
                  type="date"
                  [value]="dateValue()"
                  (input)="onDate(($any($event.target).value ))"
                  [attr.min]="dateMinAttr()"
                  [attr.max]="dateMaxAttr()"
                  class="text"
                  [class.invalid]="dateError()"
                  placeholder="AAAA-MM-DD"
                />
                <div class="hint" *ngIf="dateHint()">{{ dateHint() }}</div>
                <div class="error" *ngIf="dateError()">{{ dateError() }}</div>
              </ng-container>
              <ng-template #dateLite>
                <div class="lite-row">
                  <span class="lite-label">{{ label() }}:</span>
                  <span class="lite-value">{{ displayValue() || '—' }}</span>
                </div>
              </ng-template>
            </div>
          </ng-template>

          <!-- STRING -->
          <ng-template #maybeString>
            <div class="string-input" *ngIf="isStringInput(); else regularChildren">
              <ng-container *ngIf="!lite; else stringLite">
                <input
                  type="text"
                  [value]="textValue()"
                  (input)="onText(($any($event.target).value ))"
                  [attr.minlength]="exactLen() ?? minLen() ?? null"
                  [attr.maxlength]="exactLen() ?? maxLen() ?? null"
                  [attr.pattern]="htmlPattern()"
                  class="text"
                  [class.invalid]="textError()"
                  [placeholder]="hint() || 'digite...'"
                />
                <div class="hint" *ngIf="hint()">{{ hint() }}</div>
                <div class="error" *ngIf="textError()">{{ textError() }}</div>
              </ng-container>
              <ng-template #stringLite>
                <div class="lite-row">
                  <span class="lite-label">{{ label() }}:</span>
                  <span class="lite-value">{{ displayValue() || '—' }}</span>
                </div>
              </ng-template>
            </div>

            <!-- Filhos padrão -->
            <ng-template #regularChildren>
              <div class="children" *ngIf="node.children?.length">
                <app-xs-tree-node 
                  *ngFor="let c of node.children" 
                  [node]="c" 
                  [idPrefix]="idPrefix"
                  [vPrefix]="((node.kind || '').toLowerCase() === 'element' ? getVisualPath() : vPrefix)"
                  [lite]="lite"
                ></app-xs-tree-node>
              </div>
            </ng-template>
          </ng-template>
        </ng-template>

      </details>
    </ng-template>
  </ng-template>
</ng-template>
